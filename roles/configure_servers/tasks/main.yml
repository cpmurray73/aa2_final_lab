---
# tasks file for configure_servers
#
- name: Get control IP address
  shell:
    cmd: ip addr show eth0 | awk '/inet / { print $2 }' | sed 's/\/.*//'
  delegate_to: localhost
  register: control_ip
  become: false

- name: Ensure DNS configuration
  command: >-
    nmcli connection modify "System eth0"
    ipv4.ignore-auto-dns yes
    ipv4.dns {{ control_ip.stdout }}
    +ipv4.dns {{ ansible_dns.nameservers.0 }}
    +ipv4.dns 8.8.8.8

- name: Restart networking
  service:
    name: NetworkManager
    state: restarted

- name: Install katello-ca-consumer package
  yum:
    name:              http://satellite.example.com/pub/katello-ca-consumer-latest.noarch.rpm
    state:             present
    disable_gpg_check: true

- name: register system and attach subs
  redhat_subscription:
    state:         present
    activationkey: "{{ satellite_activationkey }}"
    org_id:        "{{ satellite_org }}"
    auto_attach:   true

